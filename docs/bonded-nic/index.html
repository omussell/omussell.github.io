<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <title>Creating Bonded NICs on Ubuntu 20.04</title>
    <meta name="description" content="">

    <link rel="stylesheet" href="https://omussell.github.io/main.css">

    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="https://omussell.github.io/atom.xml">
    

    
    
</head>
<body>
    <a class="skip-main" href="#main">Skip to content</a>
    <div class="container">
        <header> 
            <h1 class="site-header">
                <a href="https:&#x2F;&#x2F;omussell.github.io"></a>
            </h1>
            <nav>
                
                
                
                <a  href="https:&#x2F;&#x2F;omussell.github.io&#x2F;about&#x2F;">About</a>
                
                
                <a  href="https:&#x2F;&#x2F;omussell.github.io&#x2F;">Blog</a>
                
                
                <a  href="https:&#x2F;&#x2F;omussell.github.io&#x2F;tags&#x2F;">Tags</a>
                
                
            </nav>
        </header>
        <main id="main" tabindex="-1">
            

<article class="post">
    <header>
        <h1>Creating Bonded NICs on Ubuntu 20.04</h1>
    </header>
    <div class="content">
        <h2 id="summary">Summary</h2>
<p>On the HP MicroServer Gen 8 and MicroServer Gen 10+ there are four ethernet ports. I wanted to group these together into a bonded NIC so that ethernet traffic could run over all four to increase the throughput.</p>
<p>There are other names for bonding, like teaming or link aggregation/LACP. They all mean the same thing, multiple network ports joined together to serve traffic.</p>
<h2 id="setup">Setup</h2>
<p>Install the dependency:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>apt install ifenslave
</span></code></pre>
<p>Load the kernel module:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span># Check if already loaded:
</span><span>lsmod | grep bonding
</span><span>
</span><span># If no output then:
</span><span>modprobe bonding
</span></code></pre>
<p>This only loads the bonding kernel module while the system is running, it would be lost on reboot. Add it to the modules file to load it at boot as well:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>vim /etc/modules
</span><span>
</span><span># Add the following line to the file:
</span><span>bonding
</span><span>
</span></code></pre>
<p>Find the network interfaces. You can do this in a few different ways, an easy way is just:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>ip addr
</span></code></pre>
<p>Which lists all of your network interfaces. <code>lo</code> is for loopback, then the others will be your ethernet interfaces. This can differ between different NIC manufacturers. On this machine, its returning names like <code>eno1</code>, <code>eno2</code> etc. Sometimes it is like <code>enp2s0</code> or <code>enp3s0</code> instead.</p>
<p>Edit the netplan config file to add the config. You will need to know the IP address of your gateway/router and the IP addresses for the DNS nameservers. For me, the router IP is <code>192.168.0.1</code> and the DNS servers are <code>192.168.0.15</code> (Rpi) and <code>1.1.1.1</code> (Cloudflare).</p>
<p>Also, I've set the bonded NIC to use DHCP to configure its IP address. I'm also using all available <code>eno*</code> ethernet ports in the bond. If you want to use a specific set of ports instead, check out the <a href="https://netplan.io/examples/">netplan documentation</a></p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>vim /etc/netplan/00-installer-config.yaml
</span><span>
</span><span>network:
</span><span>  version: 2
</span><span>  ethernets:
</span><span>    eports:
</span><span>      match:
</span><span>        name: eno*
</span><span>      optional: true
</span><span>  bonds:
</span><span>    bond0:
</span><span>      interfaces: [eports]
</span><span>      dhcp4: true
</span><span>      gateway4: 192.168.0.1
</span><span>      nameservers:
</span><span>        addresses: [192.168.0.15, 1.1.1.1]
</span><span>      parameters:
</span><span>        mode: 802.3ad
</span><span>        lacp-rate: fast
</span><span>        mii-monitor-interval: 100
</span></code></pre>
<p>Apply the changes:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>netplan apply
</span></code></pre>
<p>If you lose your SSH connection, something went wrong, or DHCP has just decided to give it a different IP address than what you used to connect. Its a good idea to have out of band management or a spare keyboard+monitor plugged in if the network stops working.</p>
<h2 id="end-result">End result</h2>
<p>If you run <code>ip addr</code> again, you can now see a new network interface has been created called <code>bond0</code>, which is the master. Then the <code>eno*</code> interfaces have been added as slaves of <code>bond0</code>.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>root@dixie:~# ip addr
</span><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span><span>    inet 127.0.0.1/8 scope host lo
</span><span>       valid_lft forever preferred_lft forever
</span><span>    inet6 ::1/128 scope host 
</span><span>       valid_lft forever preferred_lft forever
</span><span>2: eno1: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc mq master bond0 state UP group default qlen 1000
</span><span>    link/ether de:d5:c6:da:5b:a0 brd ff:ff:ff:ff:ff:ff
</span><span>3: eno2: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc mq master bond0 state UP group default qlen 1000
</span><span>    link/ether de:d5:c6:da:5b:a0 brd ff:ff:ff:ff:ff:ff
</span><span>4: eno3: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc mq master bond0 state UP group default qlen 1000
</span><span>    link/ether de:d5:c6:da:5b:a0 brd ff:ff:ff:ff:ff:ff
</span><span>5: eno4: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc mq master bond0 state UP group default qlen 1000
</span><span>    link/ether de:d5:c6:da:5b:a0 brd ff:ff:ff:ff:ff:ff
</span><span>6: bond0: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
</span><span>    link/ether de:d5:c6:da:5b:a0 brd ff:ff:ff:ff:ff:ff
</span><span>    inet 192.168.0.21/24 brd 192.168.0.255 scope global dynamic bond0
</span><span>       valid_lft 84976sec preferred_lft 84976sec
</span><span>    inet6 fe80::dcd5:c6ff:feda:5ba0/64 scope link 
</span><span>       valid_lft forever preferred_lft forever
</span></code></pre>

    </div>

    
    <div class="article-info">
        
        <div class="article-date">27 March 2021</div>
        
        <div class="article-taxonomies">
            
            
                <ul class="article-tags">
                    
                    <li><a href="https://omussell.github.io/tags/homelab/">#homelab</a></li>
                    
                    <li><a href="https://omussell.github.io/tags/hardware/">#hardware</a></li>
                    
                </ul>
            
        </div>
    </div>

</article>


        </main>
        <footer>
            <p>
                Â©  2021<br>
                Powered by <a target="_blank" href="https://getzola.com/">Zola</a>, Theme <a target="_blank" href="https://github.com/zbrox/anpu-zola-theme">Anpu</a>.
            </p>
            <p>
                
                
            </p>
        </footer>
    </div>
</body>
</html>
