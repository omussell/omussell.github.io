<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <title>Firecracker</title>
    <meta name="description" content="">

    <link rel="stylesheet" href="https://omussell.github.io/main.css">

    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="https://omussell.github.io/atom.xml">
    

    
    
</head>
<body>
    <a class="skip-main" href="#main">Skip to content</a>
    <div class="container">
        <header> 
            <h1 class="site-header">
                <a href="https:&#x2F;&#x2F;omussell.github.io"></a>
            </h1>
            <nav>
                
                
                
                <a  href="https:&#x2F;&#x2F;omussell.github.io&#x2F;about&#x2F;">About</a>
                
                
                <a  href="https:&#x2F;&#x2F;omussell.github.io&#x2F;">Blog</a>
                
                
                <a  href="https:&#x2F;&#x2F;omussell.github.io&#x2F;tags&#x2F;">Tags</a>
                
                
            </nav>
        </header>
        <main id="main" tabindex="-1">
            

<article class="post">
    <header>
        <h1>Firecracker</h1>
    </header>
    <div class="content">
        <h1 id="firecracker">Firecracker</h1>
<p><a href="https://github.com/firecracker-microvm/firecracker">Firecracker</a> - Secure and fast microVMs for serverless computing.</p>
<h2 id="quickstart">Quickstart</h2>
<p><a href="https://github.com/firecracker-microvm/firecracker/blob/main/docs/getting-started.md">Quickstart</a></p>
<h3 id="get-firecracker">Get firecracker</h3>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>release_url=&quot;https://github.com/firecracker-microvm/firecracker/releases&quot;
</span><span>latest=$(basename $(curl -fsSLI -o /dev/null -w  %{url_effective} ${release_url}/latest))
</span><span>curl -L ${release_url}/download/${latest}/firecracker-${latest}-x86_64.tgz | tar -xz
</span><span>
</span></code></pre>
<h3 id="get-the-kernel-and-rootfs">Get the kernel and rootfs</h3>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span># Official instructions
</span><span>
</span><span>dest_kernel=&quot;hello-vmlinux.bin&quot;
</span><span>dest_rootfs=&quot;hello-rootfs.ext4&quot;
</span><span>image_bucket_url=&quot;https://s3.amazonaws.com/spec.ccfc.min/img/quickstart_guide/x86_64&quot;
</span><span>
</span><span>
</span><span>kernel=&quot;${image_bucket_url}/kernels/vmlinux.bin&quot;
</span><span>rootfs=&quot;${image_bucket_url}/rootfs/bionic.rootfs.ext4&quot;
</span><span>
</span><span>curl -fsSL -o $dest_kernel $kernel
</span><span>curl -fsSL -o $dest_rootfs $rootfs
</span><span>
</span><span>
</span><span>
</span><span># Same but with a recently built image as gleaned from the bucket list
</span><span>dest_kernel=&quot;hello-vmlinux.bin&quot;
</span><span>dest_rootfs=&quot;hello-rootfs.ext4&quot;
</span><span>kernel=&quot;https://s3.amazonaws.com/spec.ccfc.min/img-dev/x86_64/ubuntu/kernel/vmlinux.bin&quot;
</span><span>rootfs=&quot;https://s3.amazonaws.com/spec.ccfc.min/img-dev/x86_64/ubuntu/fsfiles/bionic.rootfs.ext4&quot;
</span><span>curl -fsSL -o $dest_kernel $kernel
</span><span>curl -fsSL -o $dest_rootfs $rootfs
</span></code></pre>
<h2 id="using-firectl">Using firectl</h2>
<h3 id="get-firectl">Get firectl</h3>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>curl -Lo firectl https://firectl-release.s3.amazonaws.com/firectl-v0.1.0
</span><span>chmod +x firectl
</span></code></pre>
<h3 id="create-microvm">Create microvm</h3>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>./firectl \
</span><span>  --kernel=hello-vmlinux.bin \
</span><span>  --root-drive=hello-rootfs.ext4
</span></code></pre>
<h2 id="using-the-api">Using the API</h2>
<h3 id="set-the-guest-kernel">Set the guest kernel</h3>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>kernel_path=$(pwd)&quot;/hello-vmlinux.bin&quot;
</span><span>
</span><span>curl --unix-socket /tmp/firecracker.socket -i \
</span><span>  -X PUT &#39;http://localhost/boot-source&#39;   \
</span><span>  -H &#39;Accept: application/json&#39;           \
</span><span>  -H &#39;Content-Type: application/json&#39;     \
</span><span>  -d &quot;{
</span><span>        \&quot;kernel_image_path\&quot;: \&quot;${kernel_path}\&quot;,
</span><span>        \&quot;boot_args\&quot;: \&quot;console=ttyS0 reboot=k panic=1 pci=off\&quot;
</span><span>   }&quot;
</span></code></pre>
<h3 id="set-the-guest-rootf">Set the guest rootf</h3>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>rootfs_path=$(pwd)&quot;/hello-rootfs.ext4&quot;
</span><span>curl --unix-socket /tmp/firecracker.socket -i \
</span><span>  -X PUT &#39;http://localhost/drives/rootfs&#39; \
</span><span>  -H &#39;Accept: application/json&#39;           \
</span><span>  -H &#39;Content-Type: application/json&#39;     \
</span><span>  -d &quot;{
</span><span>        \&quot;drive_id\&quot;: \&quot;rootfs\&quot;,
</span><span>        \&quot;path_on_host\&quot;: \&quot;${rootfs_path}\&quot;,
</span><span>        \&quot;is_root_device\&quot;: true,
</span><span>        \&quot;is_read_only\&quot;: false
</span><span>   }&quot;
</span></code></pre>
<h3 id="start-the-guest-machine">Start the guest machine</h3>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>curl --unix-socket /tmp/firecracker.socket -i \
</span><span>  -X PUT &#39;http://localhost/actions&#39;       \
</span><span>  -H  &#39;Accept: application/json&#39;          \
</span><span>  -H  &#39;Content-Type: application/json&#39;    \
</span><span>  -d &#39;{
</span><span>      &quot;action_type&quot;: &quot;InstanceStart&quot;
</span><span>   }&#39;
</span></code></pre>
<h2 id="compile-kernel-and-fs-manually">Compile Kernel and FS manually</h2>
<p>Follow the steps in <a href="https://github.com/firecracker-microvm/firecracker/blob/master/docs/rootfs-and-kernel-setup.md">here</a> to compile the kernel and base file. </p>
<p>On Ubuntu when compiling you need to install dependencies like libssl-dev, libncurses-dev, bison, autoconf.</p>
<p>Then if you try and compile and it complains about auto.conf not existing, run make menuconfig, then exit out immediately. That seems to have sorted it.</p>
<p>Then when you run make vmlinux it asks lots of questions, but by using the preexisting config file from the repo a lot has already been decided. You could probably pipe yes into this, or otherwise just hold enter. Someone with more kernel experience needs to go over those options and decide if they're necessary. </p>
<p>Once compiled continue with the getting started instructions but change the path to the kernel file to the vmlinux you created.</p>
<p>I compiled 5.4 kernel and used the existing alpine base from the getting started and it boots just fine.</p>
<h2 id="using-the-jailer">Using the jailer</h2>
<h3 id="install">Install</h3>
<p>The jailer is used to provide additional isolation for the VMs.</p>
<p>The jailer binary is included in the tgz file from the firecracker release.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span># It needs to be built statically linked to musl.
</span><span>
</span><span>apt install -y musl-tools
</span><span>
</span><span># install rust via rustup
</span><span>
</span><span># cd into the jailer directory in the firecracker repo
</span><span>cargo build --target=&quot;x86_64-unknown-linux-musl&quot; --release
</span><span>
</span><span># the built binary gets created at:
</span><span>../../build/cargo_target/x86_64-unknown-linux-musl/release/jailer
</span><span>
</span><span># you should probably build with tools/devtool build instead
</span></code></pre>
<h3 id="run">Run</h3>
<p>Rather than running the jailer binary manually, you can use the <code>--jailer</code> flag with firectl. Note that you must also include the <code>--chroot-base-dir=&quot;/srv/jailer&quot;</code> flag, otherwise you get the <code>no such file or directory</code> error as per <a href="https://github.com/firecracker-microvm/firecracker-go-sdk/issues/313">this issue</a>.</p>
<p>You also need to copy or move the firectl, firecracker, and jailer binaries into a bin directory in your $PATH otherwise it complains. I copied them to /usr/local/bin</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>/usr/local/bin/firectl --kernel=/root/release-v0.25.2-x86_64/hello-vmlinux.bin --root-drive=/root/release-v0.25.2-x86_64/hello-rootfs.ext4 --jailer=/usr/local/bin/jailer --exec-file=/usr/local/bin/firecracker --id=testvm4 --chroot-base-dir=&quot;/srv/jailer&quot;
</span></code></pre>
<p>Firectl also doesnt handle cleaning up the /srv/jailer/firecracker/$vm_name chroot directory when you power off the VM. So you need to clean this up manually.</p>

    </div>

    
    <div class="article-info">
        
        <div class="article-date"> 9 December 2021</div>
        
        <div class="article-taxonomies">
            
            
                <ul class="article-tags">
                    
                    <li><a href="https://omussell.github.io/tags/homelab/">#homelab</a></li>
                    
                </ul>
            
        </div>
    </div>

</article>


        </main>
        <footer>
            <p>
                Â©  2022<br>
                Powered by <a target="_blank" href="https://getzola.com/">Zola</a>, Theme <a target="_blank" href="https://github.com/zbrox/anpu-zola-theme">Anpu</a>.
            </p>
            <p>
                
                
            </p>
        </footer>
    </div>
</body>
</html>
